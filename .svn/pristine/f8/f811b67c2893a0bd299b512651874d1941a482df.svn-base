import {
  request,
  summary,
  body,
  tags,
  middlewares,
  path,
  description
} from '../../dist';
import dbClient from '../middleware/db'

const tag = tags(['User']);

const userSchema = {
  name: { type: 'string', required: true },
  password: { type: 'string', required: true },
  phone: { type: 'string' ,require: true },
  sex: { type: 'number' },
  address: { type: 'string' }
};

const logTime = () => async (ctx, next) => {
  console.log(`start: ${new Date()}`);
  await next();
  console.log(`end: ${new Date()}`);
};
export default class UserRouter {
  @request('POST', '/user/register')
  @summary('register user')
  @description('example of api')
  @tag
  @middlewares([logTime()])
  @body(userSchema)
  static async register(ctx) {
    // const { name } = ctx.validatedBody;
    let json = {
      name: '张三',
      password: '123456',
      age: 15,
      sex: 1,
      address: '四川成都市高新区'
    }
    let result = await dbClient.insert('users',json)
    // const user = { name };
    ctx.body = result;
  }

  @request('post', '/user/login')
  @summary('user login, password is 123456')
  @tag
  @body(userSchema)
  static async login(ctx) {
    const { name, password } = ctx.validatedBody;
    if (password !== '123456') throw new Error('wrong password');
    const user = { name };
    ctx.body = { user };
  }

  @request('get', '/user')
  @summary('user list')
  @tag
  static async getAll(ctx) {
    let result = await dbClient.find('users',{})
    ctx.body = result;
  }

  @request('get', '/user/{id}')
  @summary('get user by id')
  @tag
  @path({ id: { type: 'string', required: true } })
  static async getOne(ctx) {
    const { id } = ctx.validatedParams;
    console.log('id:', id);
    const user = { name: 'foo' };
    ctx.body = { user };
  }

  @request('DELETE', '/user/{id}')
  @summary('delete user by objectId')
  @tag
  @path({ id: { type: 'string', required: true } })
  static async deleteOne(ctx) {
    const { id } = ctx.validatedParams;
    let result = await dbClient.remove('users',{'_id':dbClient.getObjectId(id) })
    ctx.body = result;
  }
}
